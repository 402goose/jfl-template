#!/usr/bin/env node

/**
 * CRM CLI - 4-Table Structure
 *
 * Tables: Companies, Contacts, Deals, Activities
 *
 * Usage:
 *   ./crm                           - Show insights dashboard
 *   ./crm stale                     - Show stale deals (5+ days)
 *   ./crm priority                  - Show high priority deals
 *   ./crm prep <contact>            - Prep for a call (show all context)
 *   ./crm touch <contact>           - Log an activity
 *   ./crm list [contacts|deals|companies]
 *   ./crm add contact "Name" "Company"
 *   ./crm add deal "Name" "Contact" "Pipeline"
 *   ./crm add activity "Contact" "Type" "Notes"
 *   ./crm update <contact> <field> <value>
 *   ./crm assign <contact> <owner>
 */

import { google } from 'googleapis';

const SHEET_ID = process.env.CRM_SHEET_ID || '1f4mgUlE2JrNTlZ6g02uxsr2ctkdmMX_emehDBw88KHk';

async function getAuth() {
  const auth = new google.auth.GoogleAuth({
    scopes: ['https://www.googleapis.com/auth/spreadsheets']
  });
  return auth;
}

async function getSheets() {
  const auth = await getAuth();
  return google.sheets({ version: 'v4', auth });
}

// ============ HELPERS ============

function today() {
  return new Date().toISOString().split('T')[0];
}

function daysSince(dateStr) {
  if (!dateStr) return 999;
  const date = new Date(dateStr);
  const now = new Date();
  return Math.floor((now - date) / (1000 * 60 * 60 * 24));
}

function stageIcon(stage) {
  return {
    'COLD': '‚ö™',
    'RESEARCHING': 'üîµ',
    'REACHED_OUT': 'üü°',
    'REPLIED': 'üü°',
    'IN_CONVO': 'üü†',
    'TALKING': 'üü†',
    'WARM': 'üü¢',
    'COMMITTED': '‚úÖ',
    'ACTIVE': '‚úÖ',
    'CLOSED_WON': '‚úÖ',
    'PASSED': '‚ùå',
    'CLOSED_LOST': '‚ùå',
    'CHURNED': '‚ùå'
  }[stage] || '‚ö™';
}

function priorityIcon(priority) {
  return { 'High': 'üî•', 'Medium': 'üî∏', 'Low': '‚ö™' }[priority] || '‚ö™';
}

// ============ DATA ACCESS ============

async function getTable(name) {
  const sheets = await getSheets();
  const res = await sheets.spreadsheets.values.get({
    spreadsheetId: SHEET_ID,
    range: `${name}!A:Z`,
  });
  const rows = res.data.values || [];
  if (rows.length < 2) return [];

  const headers = rows[0];
  return rows.slice(1).map((row, idx) => {
    const obj = { _row: idx + 2 };
    headers.forEach((h, i) => {
      obj[h] = row[i] || '';
    });
    return obj;
  });
}

async function updateCell(sheet, row, col, value) {
  const sheets = await getSheets();
  await sheets.spreadsheets.values.update({
    spreadsheetId: SHEET_ID,
    range: `${sheet}!${col}${row}`,
    valueInputOption: 'RAW',
    resource: { values: [[value]] }
  });
}

async function appendRow(sheet, values) {
  const sheets = await getSheets();
  await sheets.spreadsheets.values.append({
    spreadsheetId: SHEET_ID,
    range: `${sheet}!A:Z`,
    valueInputOption: 'RAW',
    resource: { values: [values] }
  });
}

// ============ INSIGHTS ============

async function showDashboard() {
  const deals = await getTable('Deals');
  const activities = await getTable('Activities');

  console.log('\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
  console.log('                        CRM DASHBOARD');
  console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');

  // Stale (IN_CONVO or REACHED_OUT, 5+ days)
  const stale = deals.filter(d =>
    ['IN_CONVO', 'REACHED_OUT', 'TALKING', 'REPLIED'].includes(d.Stage) &&
    daysSince(d.Updated) >= 5
  );

  if (stale.length > 0) {
    console.log('‚ö†Ô∏è  NEEDS FOLLOW-UP (' + stale.length + ')');
    console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
    stale.forEach(d => {
      console.log(`  ${d.Contact} @ ${d.Company} - ${d.Stage} (${daysSince(d.Updated)} days)`);
    });
    console.log('');
  }

  // High priority not closed
  const highPri = deals.filter(d =>
    d.Priority === 'High' &&
    !['COMMITTED', 'ACTIVE', 'CLOSED_WON', 'PASSED', 'CLOSED_LOST'].includes(d.Stage)
  );

  if (highPri.length > 0) {
    console.log('üî• HIGH PRIORITY (' + highPri.length + ')');
    console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
    highPri.forEach(d => {
      console.log(`  ${d.Contact} @ ${d.Company} - ${d.Stage} [${d.Pipeline}]`);
    });
    console.log('');
  }

  // Recent wins
  const wins = deals.filter(d => ['COMMITTED', 'ACTIVE', 'CLOSED_WON'].includes(d.Stage));
  console.log('‚úÖ COMMITTED (' + wins.length + ')');
  console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
  wins.slice(0, 5).forEach(d => {
    console.log(`  ${d.Contact} @ ${d.Company} - ${d.Deal}`);
  });
  console.log('');

  // Pipeline summary
  const pipelines = {};
  deals.forEach(d => {
    const p = d.Pipeline || 'Other';
    pipelines[p] = pipelines[p] || { total: 0, stages: {} };
    pipelines[p].total++;
    pipelines[p].stages[d.Stage] = (pipelines[p].stages[d.Stage] || 0) + 1;
  });

  console.log('üìä PIPELINES');
  console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
  for (const [name, data] of Object.entries(pipelines)) {
    const summary = Object.entries(data.stages)
      .map(([s, c]) => `${stageIcon(s)} ${c}`)
      .join(' ');
    console.log(`  ${name}: ${data.total} deals - ${summary}`);
  }
  console.log('');

  // Recent activity
  const recentActivities = activities.slice(-5).reverse();
  if (recentActivities.length > 0) {
    console.log('üìù RECENT ACTIVITY');
    console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
    recentActivities.forEach(a => {
      console.log(`  ${a.Date} | ${a.Type} | ${a.Contact} @ ${a.Company}`);
    });
    console.log('');
  }

  console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');
}

async function showStale(days = 5) {
  const deals = await getTable('Deals');
  const stale = deals.filter(d =>
    !['COLD', 'COMMITTED', 'ACTIVE', 'CLOSED_WON', 'PASSED', 'CLOSED_LOST'].includes(d.Stage) &&
    daysSince(d.Updated) >= days
  ).sort((a, b) => daysSince(b.Updated) - daysSince(a.Updated));

  console.log(`\n‚ö†Ô∏è  STALE DEALS (${days}+ days without activity)\n`);

  if (stale.length === 0) {
    console.log('  None! You\'re on top of things.\n');
    return;
  }

  stale.forEach(d => {
    const daysAgo = daysSince(d.Updated);
    console.log(`  ${stageIcon(d.Stage)} ${d.Contact.padEnd(20)} @ ${d.Company.padEnd(15)} ${d.Stage.padEnd(12)} ${daysAgo} days`);
    if (d['Next Action']) console.log(`     ‚Üí Next: ${d['Next Action']}`);
  });
  console.log('');
}

async function showPriority() {
  const deals = await getTable('Deals');

  console.log('\nüî• PRIORITY DEALS\n');

  ['High', 'Medium'].forEach(priority => {
    const filtered = deals.filter(d =>
      d.Priority === priority &&
      !['COMMITTED', 'ACTIVE', 'CLOSED_WON', 'PASSED', 'CLOSED_LOST'].includes(d.Stage)
    );

    if (filtered.length > 0) {
      console.log(`‚îÄ‚îÄ ${priority.toUpperCase()} ‚îÄ‚îÄ`);
      filtered.forEach(d => {
        console.log(`  ${stageIcon(d.Stage)} ${d.Contact} @ ${d.Company} - ${d.Stage} [${d.Owner || 'unassigned'}]`);
      });
      console.log('');
    }
  });
}

async function prepContact(query) {
  const contacts = await getTable('Contacts');
  const deals = await getTable('Deals');
  const activities = await getTable('Activities');
  const companies = await getTable('Companies');

  const cleanQuery = query.replace('@', '').toLowerCase();
  const contact = contacts.find(c =>
    c.Name.toLowerCase().includes(cleanQuery) ||
    (c.Handle || '').toLowerCase().includes(cleanQuery)
  );

  if (!contact) {
    console.log(`\nContact "${query}" not found.\n`);
    return;
  }

  const company = companies.find(c => c.Company === contact.Company);
  const contactDeals = deals.filter(d => d.Contact.includes(contact.Name) || d.Company === contact.Company);
  const contactActivities = activities.filter(a =>
    a.Contact.includes(contact.Name) || a.Company === contact.Company
  ).sort((a, b) => b.Date.localeCompare(a.Date));

  console.log('\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
  console.log(`  PREP: ${contact.Name}`);
  console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');

  console.log('üë§ CONTACT');
  console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
  console.log(`  Name:     ${contact.Name}`);
  console.log(`  Company:  ${contact.Company}`);
  if (contact.Role) console.log(`  Role:     ${contact.Role}`);
  if (contact.Handle) console.log(`  Handle:   ${contact.Handle}`);
  if (contact.Email) console.log(`  Email:    ${contact.Email}`);
  if (contact['Last Touch']) console.log(`  Last Touch: ${contact['Last Touch']} (${daysSince(contact['Last Touch'])} days ago)`);
  if (contact.Notes) console.log(`  Notes:    ${contact.Notes}`);
  console.log('');

  if (company) {
    console.log('üè¢ COMPANY');
    console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
    console.log(`  ${company.Company}`);
    if (company.Industry) console.log(`  Industry: ${company.Industry}`);
    if (company.Website) console.log(`  Website:  ${company.Website}`);
    if (company.Notes) console.log(`  Notes:    ${company.Notes}`);
    console.log('');
  }

  if (contactDeals.length > 0) {
    console.log('üíº DEALS');
    console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
    contactDeals.forEach(d => {
      console.log(`  ${stageIcon(d.Stage)} ${d.Deal}`);
      console.log(`     Pipeline: ${d.Pipeline} | Stage: ${d.Stage}`);
      if (d['Next Action']) console.log(`     Next: ${d['Next Action']}`);
      if (d.Notes) console.log(`     Notes: ${d.Notes}`);
    });
    console.log('');
  }

  if (contactActivities.length > 0) {
    console.log('üìù ACTIVITY HISTORY');
    console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
    contactActivities.slice(0, 10).forEach(a => {
      console.log(`  ${a.Date} | ${a.Type}`);
      if (a.Notes) console.log(`     ${a.Notes}`);
    });
    console.log('');
  }

  console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');
}

// ============ ACTIONS ============

async function logActivity(contactQuery, type, notes) {
  const contacts = await getTable('Contacts');
  const deals = await getTable('Deals');

  const cleanQuery = contactQuery.replace('@', '').toLowerCase();
  const contact = contacts.find(c =>
    c.Name.toLowerCase().includes(cleanQuery) ||
    (c.Handle || '').toLowerCase().includes(cleanQuery)
  );

  if (!contact) {
    console.log(`\nContact "${contactQuery}" not found.\n`);
    return;
  }

  // Find associated deal
  const deal = deals.find(d => d.Contact.includes(contact.Name));

  // Add activity
  await appendRow('Activities', [
    today(),
    contact.Name,
    contact.Company,
    type,
    notes || '',
    deal ? deal.Deal : ''
  ]);

  // Update contact last touch
  await updateCell('Contacts', contact._row, 'I', today());

  // Update deal if exists
  if (deal) {
    await updateCell('Deals', deal._row, 'J', today()); // Updated
    await updateCell('Deals', deal._row, 'M', '0');     // Days Stale = 0
  }

  console.log(`\n‚úì Logged ${type} with ${contact.Name}`);
  if (deal) console.log(`  Updated deal: ${deal.Deal}`);
  console.log('');
}

async function assignDeal(contactQuery, owner) {
  const deals = await getTable('Deals');

  const cleanQuery = contactQuery.replace('@', '').toLowerCase();
  const deal = deals.find(d =>
    d.Contact.toLowerCase().includes(cleanQuery) ||
    d.Company.toLowerCase().includes(cleanQuery)
  );

  if (!deal) {
    console.log(`\nDeal for "${contactQuery}" not found.\n`);
    return;
  }

  await updateCell('Deals', deal._row, 'L', owner);
  console.log(`\n‚úì Assigned ${deal.Deal} to ${owner}\n`);
}

async function updateDealStage(contactQuery, stage) {
  const deals = await getTable('Deals');

  const cleanQuery = contactQuery.replace('@', '').toLowerCase();
  const deal = deals.find(d =>
    d.Contact.toLowerCase().includes(cleanQuery) ||
    d.Company.toLowerCase().includes(cleanQuery)
  );

  if (!deal) {
    console.log(`\nDeal for "${contactQuery}" not found.\n`);
    return;
  }

  // Update stage
  await updateCell('Deals', deal._row, 'E', stage);
  await updateCell('Deals', deal._row, 'J', today());
  await updateCell('Deals', deal._row, 'M', '0');

  // Update priority based on stage
  let priority = 'Medium';
  if (['COMMITTED', 'IN_CONVO', 'TALKING'].includes(stage)) priority = 'High';
  if (stage === 'COLD') priority = 'Low';
  await updateCell('Deals', deal._row, 'K', priority);

  // Log activity
  const contacts = await getTable('Contacts');
  const contact = contacts.find(c => c.Name.includes(deal.Contact));

  await appendRow('Activities', [
    today(),
    deal.Contact,
    deal.Company,
    'Stage Change',
    `${deal.Stage} ‚Üí ${stage}`,
    deal.Deal
  ]);

  console.log(`\n‚úì Updated ${deal.Contact} ‚Üí ${stage}\n`);
}

async function addContact(name, company, handle, role) {
  await appendRow('Contacts', [name, company, role || '', '', handle || '', '', '', today(), '']);
  console.log(`\n‚úì Added contact: ${name} @ ${company}\n`);
}

async function addDeal(name, contact, pipeline, stage = 'COLD') {
  const contacts = await getTable('Contacts');
  const c = contacts.find(x => x.Name.toLowerCase().includes(contact.toLowerCase()));
  const company = c ? c.Company : '';

  let priority = 'Medium';
  if (['COMMITTED', 'IN_CONVO'].includes(stage)) priority = 'High';
  if (stage === 'COLD') priority = 'Low';

  await appendRow('Deals', [
    name,
    c ? c.Name : contact,
    company,
    pipeline,
    stage,
    '',
    '',
    '',
    '',
    today(),
    priority,
    'goose',
    '0'
  ]);
  console.log(`\n‚úì Added deal: ${name} [${pipeline}]\n`);
}

async function listTable(table) {
  const data = await getTable(table);

  console.log(`\n${table.toUpperCase()} (${data.length})\n`);

  if (table === 'Contacts') {
    data.forEach(c => {
      console.log(`  ${c.Name.padEnd(25)} @ ${(c.Company || '').padEnd(15)} ${c.Handle || ''}`);
    });
  } else if (table === 'Deals') {
    data.forEach(d => {
      console.log(`  ${stageIcon(d.Stage)} ${d.Contact.padEnd(20)} ${d.Stage.padEnd(12)} [${d.Pipeline}]`);
    });
  } else if (table === 'Companies') {
    data.forEach(c => {
      console.log(`  ${c.Company.padEnd(25)} ${c.Industry || ''}`);
    });
  } else if (table === 'Activities') {
    data.slice(-20).reverse().forEach(a => {
      console.log(`  ${a.Date} | ${a.Type.padEnd(15)} | ${a.Contact} @ ${a.Company}`);
    });
  }
  console.log('');
}

// ============ MAIN ============

async function main() {
  const args = process.argv.slice(2);
  const command = args[0];

  if (!SHEET_ID) {
    console.log(`
Error: No Google Sheet configured.

To set up:
1. Create a new Google Sheet (or use existing)
2. Set the sheet ID: export CRM_SHEET_ID="your-sheet-id"
3. Ensure Google Cloud credentials are configured
`);
    return;
  }

  if (!command) {
    await showDashboard();
    return;
  }

  try {
    switch (command) {
      case 'stale':
        await showStale(parseInt(args[1]) || 5);
        break;

      case 'priority':
        await showPriority();
        break;

      case 'prep':
        if (!args[1]) {
          console.log('\nUsage: ./crm prep <contact>\n');
          return;
        }
        await prepContact(args[1]);
        break;

      case 'touch':
      case 'log':
        if (!args[1]) {
          console.log('\nUsage: ./crm touch <contact> [type] [notes]\n');
          console.log('Types: Call, Email, DM, Meeting, Note\n');
          return;
        }
        await logActivity(args[1], args[2] || 'Note', args[3] || '');
        break;

      case 'assign':
        if (!args[1] || !args[2]) {
          console.log('\nUsage: ./crm assign <contact> <owner>\n');
          return;
        }
        await assignDeal(args[1], args[2]);
        break;

      case 'update':
      case 'move':
        if (!args[1] || !args[2]) {
          console.log('\nUsage: ./crm update <contact> <stage>\n');
          console.log('Stages: COLD, REACHED_OUT, REPLIED, IN_CONVO, COMMITTED, PASSED\n');
          return;
        }
        await updateDealStage(args[1], args[2]);
        break;

      case 'add':
        const subCmd = args[1];
        if (subCmd === 'contact') {
          await addContact(args[2], args[3], args[4], args[5]);
        } else if (subCmd === 'deal') {
          await addDeal(args[2], args[3], args[4], args[5]);
        } else {
          console.log('\nUsage: ./crm add contact "Name" "Company" [@handle] [role]');
          console.log('       ./crm add deal "Name" "Contact" "Pipeline" [stage]\n');
        }
        break;

      case 'list':
        const table = args[1] || 'Deals';
        const validTables = ['Contacts', 'Deals', 'Companies', 'Activities'];
        const match = validTables.find(t => t.toLowerCase().startsWith(table.toLowerCase()));
        if (match) {
          await listTable(match);
        } else {
          console.log(`\nUnknown table. Try: ${validTables.join(', ')}\n`);
        }
        break;

      case 'help':
        console.log(`
CRM CLI - 4-Table Structure

INSIGHTS:
  ./crm                     Dashboard (default)
  ./crm stale [days]        Show stale deals (default: 5 days)
  ./crm priority            Show high priority deals
  ./crm prep <contact>      Prep for a call (full context)

ACTIONS:
  ./crm touch <contact> [type] [notes]    Log activity (Call/Email/DM/Meeting/Note)
  ./crm update <contact> <stage>          Update deal stage
  ./crm assign <contact> <owner>          Assign deal to owner

ADD:
  ./crm add contact "Name" "Company" [@handle] [role]
  ./crm add deal "Name" "Contact" "Pipeline" [stage]

LIST:
  ./crm list [contacts|deals|companies|activities]

Stages: COLD ‚Üí REACHED_OUT ‚Üí REPLIED ‚Üí IN_CONVO ‚Üí COMMITTED (or PASSED)
`);
        break;

      default:
        // Try as contact lookup
        await prepContact(command);
    }
  } catch (err) {
    console.error('Error:', err.message);
    if (err.message.includes('invalid_grant') || err.message.includes('credentials')) {
      console.log('\nHint: Run `gcloud auth application-default login` to authenticate.');
    }
  }
}

main();
